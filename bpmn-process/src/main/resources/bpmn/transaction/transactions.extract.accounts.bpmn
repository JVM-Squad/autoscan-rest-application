<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" id="Definitions_11axzpv" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="3.7.3">
  <bpmn:process id="ImportExtractAccounts" name="Extract account names" isExecutable="true" camunda:versionTag="1.0.0" camunda:historyTimeToLive="P1D">
    <bpmn:extensionElements>
      <camunda:executionListener delegateExpression="${startProcessListener}" event="start" />
      <camunda:executionListener delegateExpression="${stopProcessListener}" event="end" />
    </bpmn:extensionElements>
    <bpmn:startEvent id="se_process">
      <bpmn:outgoing>SequenceFlow_0egzvf9</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:serviceTask id="st_read_csv" name="Extract account from CSV" camunda:delegateExpression="${extractAccountDetailsDelegate}">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="batchImportSlug">${slug}</camunda:inputParameter>
          <camunda:inputParameter name="importConfig">${importConfig}</camunda:inputParameter>
          <camunda:outputParameter name="accountLookups">${locatable}</camunda:outputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_0egzvf9</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_0wegpol</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="SequenceFlow_0egzvf9" sourceRef="se_process" targetRef="st_read_csv" />
    <bpmn:subProcess id="sp_extract_accounts" name="Locate accounts" camunda:asyncBefore="true">
      <bpmn:incoming>SequenceFlow_0wegpol</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_0wp67ry</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics isSequential="true" camunda:collection="accountLookups" camunda:elementVariable="accountLookup" />
      <bpmn:startEvent id="se_locate_account">
        <bpmn:outgoing>SequenceFlow_0ig9uso</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:serviceTask id="ServiceTask_153hryt" name="Find match" camunda:delegateExpression="${processAccountLookupDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="iban">${iban}</camunda:inputParameter>
            <camunda:inputParameter name="name">${name}</camunda:inputParameter>
            <camunda:outputParameter name="account">${id}</camunda:outputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>SequenceFlow_0blgm1l</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_13upyse</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:sequenceFlow id="SequenceFlow_0ig9uso" sourceRef="se_locate_account" targetRef="st_convert_transaction" />
      <bpmn:sequenceFlow id="SequenceFlow_13upyse" sourceRef="ServiceTask_153hryt" targetRef="eg_account_found" />
      <bpmn:endEvent id="EndEvent_1ayeh48">
        <bpmn:incoming>SequenceFlow_0gvltk4</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="SequenceFlow_0gvltk4" sourceRef="st_generate_pair" targetRef="EndEvent_1ayeh48" />
      <bpmn:serviceTask id="st_generate_pair" name="Create result pair" camunda:class="com.jongsoft.finance.bpmn.delegate.importer.ImportAccountExtractorDelegate">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="account">${account}</camunda:inputParameter>
            <camunda:inputParameter name="name">${name}</camunda:inputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>sf_account_found</bpmn:incoming>
        <bpmn:incoming>SequenceFlow_12pgal4</bpmn:incoming>
        <bpmn:incoming>SequenceFlow_0ifb8gk</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_0gvltk4</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:sequenceFlow id="SequenceFlow_0blgm1l" sourceRef="st_convert_transaction" targetRef="ServiceTask_153hryt" />
      <bpmn:serviceTask id="st_convert_transaction" name="Convert parsed transaction" camunda:delegateExpression="${prepareTransactionForExtractionDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="accountLookup">${accountLookup}</camunda:inputParameter>
            <camunda:outputParameter name="iban">${iban}</camunda:outputParameter>
            <camunda:outputParameter name="name">${name}</camunda:outputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>SequenceFlow_0ig9uso</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_0blgm1l</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:exclusiveGateway id="eg_account_found" name="Account found" default="sf_account_found">
        <bpmn:incoming>SequenceFlow_13upyse</bpmn:incoming>
        <bpmn:outgoing>sf_account_found</bpmn:outgoing>
        <bpmn:outgoing>sf_account_not_found</bpmn:outgoing>
      </bpmn:exclusiveGateway>
      <bpmn:sequenceFlow id="sf_account_found" name="yes" sourceRef="eg_account_found" targetRef="st_generate_pair" />
      <bpmn:sequenceFlow id="sf_account_not_found" name="no" sourceRef="eg_account_found" targetRef="st_locate_synonym">
        <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${account == null}</bpmn:conditionExpression>
      </bpmn:sequenceFlow>
      <bpmn:sequenceFlow id="SequenceFlow_1foqzxr" sourceRef="st_locate_synonym" targetRef="ExclusiveGateway_0w5d9dn" />
      <bpmn:serviceTask id="st_locate_synonym" name="Find by synonym" camunda:delegateExpression="${accountSynonymLookupDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="name">${name}</camunda:inputParameter>
            <camunda:outputParameter name="account">${id}</camunda:outputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>sf_account_not_found</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_1foqzxr</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:exclusiveGateway id="ExclusiveGateway_0w5d9dn" name="synonym found" default="SequenceFlow_12pgal4">
        <bpmn:incoming>SequenceFlow_1foqzxr</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_12pgal4</bpmn:outgoing>
        <bpmn:outgoing>SequenceFlow_1aq8lqf</bpmn:outgoing>
      </bpmn:exclusiveGateway>
      <bpmn:sequenceFlow id="SequenceFlow_12pgal4" name="yes" sourceRef="ExclusiveGateway_0w5d9dn" targetRef="st_generate_pair" />
      <bpmn:sequenceFlow id="SequenceFlow_1aq8lqf" sourceRef="ExclusiveGateway_0w5d9dn" targetRef="Task_16w3kks">
        <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${account == null}</bpmn:conditionExpression>
      </bpmn:sequenceFlow>
      <bpmn:serviceTask id="Task_16w3kks" name="Run rule logic" camunda:delegateExpression="${extractorRuleRunDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="accountLookup">${accountLookup}</camunda:inputParameter>
            <camunda:outputParameter name="account">${id}</camunda:outputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>SequenceFlow_1aq8lqf</bpmn:incoming>
        <bpmn:outgoing>SequenceFlow_0ifb8gk</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:sequenceFlow id="SequenceFlow_0ifb8gk" sourceRef="Task_16w3kks" targetRef="st_generate_pair" />
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="SequenceFlow_0wegpol" sourceRef="st_read_csv" targetRef="sp_extract_accounts" />
    <bpmn:sequenceFlow id="SequenceFlow_0wp67ry" sourceRef="sp_extract_accounts" targetRef="st_account_reducer" />
    <bpmn:endEvent id="EndEvent_0dzor1o">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="transactions">${resultSet}</camunda:inputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_0o2pfu4</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="SequenceFlow_0o2pfu4" sourceRef="st_account_reducer" targetRef="EndEvent_0dzor1o" />
    <bpmn:serviceTask id="st_account_reducer" name="Result reducer" camunda:asyncBefore="true" camunda:class="com.jongsoft.finance.bpmn.delegate.account.AccountReducerDelegate">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="transactions">${resultSet}</camunda:inputParameter>
          <camunda:outputParameter name="extractionResult">${extractionResult}</camunda:outputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>SequenceFlow_0wp67ry</bpmn:incoming>
      <bpmn:outgoing>SequenceFlow_0o2pfu4</bpmn:outgoing>
    </bpmn:serviceTask>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="ImportExtractAccounts">
      <bpmndi:BPMNEdge id="SequenceFlow_0o2pfu4_di" bpmnElement="SequenceFlow_0o2pfu4">
        <di:waypoint x="1520" y="277" />
        <di:waypoint x="1563" y="277" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0wp67ry_di" bpmnElement="SequenceFlow_0wp67ry">
        <di:waypoint x="1356" y="277" />
        <di:waypoint x="1420" y="277" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0wegpol_di" bpmnElement="SequenceFlow_0wegpol">
        <di:waypoint x="399" y="277" />
        <di:waypoint x="478" y="277" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0egzvf9_di" bpmnElement="SequenceFlow_0egzvf9">
        <di:waypoint x="227" y="277" />
        <di:waypoint x="299" y="277" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="se_process">
        <dc:Bounds x="191" y="259" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_1tjiemj_di" bpmnElement="st_read_csv">
        <dc:Bounds x="299" y="237" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="SubProcess_0aoz6d4_di" bpmnElement="sp_extract_accounts" isExpanded="true">
        <dc:Bounds x="478" y="113" width="878" height="327" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="SequenceFlow_0ifb8gk_di" bpmnElement="SequenceFlow_0ifb8gk">
        <di:waypoint x="1110" y="329" />
        <di:waypoint x="1110" y="266" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1aq8lqf_di" bpmnElement="SequenceFlow_1aq8lqf">
        <di:waypoint x="1001" y="369" />
        <di:waypoint x="1060" y="369" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_12pgal4_di" bpmnElement="SequenceFlow_12pgal4">
        <di:waypoint x="976" y="344" />
        <di:waypoint x="976" y="317" />
        <di:waypoint x="1084" y="317" />
        <di:waypoint x="1084" y="266" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="999" y="298" width="17" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1foqzxr_di" bpmnElement="SequenceFlow_1foqzxr">
        <di:waypoint x="909" y="369" />
        <di:waypoint x="951" y="369" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1w230af_di" bpmnElement="sf_account_not_found">
        <di:waypoint x="859" y="251" />
        <di:waypoint x="859" y="329" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="868" y="291" width="13" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_1blj3bo_di" bpmnElement="sf_account_found">
        <di:waypoint x="884" y="226" />
        <di:waypoint x="1060" y="226" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="966" y="208" width="17" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0blgm1l_di" bpmnElement="SequenceFlow_0blgm1l">
        <di:waypoint x="660" y="226" />
        <di:waypoint x="696" y="226" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0gvltk4_di" bpmnElement="SequenceFlow_0gvltk4">
        <di:waypoint x="1160" y="226" />
        <di:waypoint x="1248" y="226" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_13upyse_di" bpmnElement="SequenceFlow_13upyse">
        <di:waypoint x="796" y="226" />
        <di:waypoint x="834" y="226" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="SequenceFlow_0ig9uso_di" bpmnElement="SequenceFlow_0ig9uso">
        <di:waypoint x="534" y="226" />
        <di:waypoint x="560" y="226" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="StartEvent_038oj4w_di" bpmnElement="se_locate_account">
        <dc:Bounds x="498" y="208" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_153hryt_di" bpmnElement="ServiceTask_153hryt">
        <dc:Bounds x="696" y="186" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1ayeh48_di" bpmnElement="EndEvent_1ayeh48">
        <dc:Bounds x="1248" y="208" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_07at92d_di" bpmnElement="st_generate_pair">
        <dc:Bounds x="1060" y="186" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_1h5uogf_di" bpmnElement="st_convert_transaction">
        <dc:Bounds x="560" y="186" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ExclusiveGateway_1q0cu0r_di" bpmnElement="eg_account_found" isMarkerVisible="true">
        <dc:Bounds x="834" y="201" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="824" y="184" width="70" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_0iofc48_di" bpmnElement="st_locate_synonym">
        <dc:Bounds x="809" y="329" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ExclusiveGateway_0w5d9dn_di" bpmnElement="ExclusiveGateway_0w5d9dn" isMarkerVisible="true">
        <dc:Bounds x="951" y="344" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="939" y="401" width="75" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_11nngh1_di" bpmnElement="Task_16w3kks">
        <dc:Bounds x="1060" y="329" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_0dzor1o_di" bpmnElement="EndEvent_0dzor1o">
        <dc:Bounds x="1563" y="259" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_05wobgt_di" bpmnElement="st_account_reducer">
        <dc:Bounds x="1420" y="237" width="100" height="80" />
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
