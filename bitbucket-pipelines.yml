image: maven:3.6.3-amazoncorretto-15

pipelines:
  default:
    - step:
        caches:
          - gradle
        script:
          - bash ./gradlew classes

  tags:
    release-*:
      - step:
          name: Build
          caches:
            - gradle
          script:
            - ash ./gradlew clean build
          artifacts:
            - ./.gradle/**
            - ./**/build/**
      - step:
          name: Publish release
          caches:
            - gradle
          script:
            - export GPG_TTY=$(tty)
            - yum install openssl11 gnupg -y
            - openssl11 aes-256-cbc -a -k "$SIGNING_PWD" -in private-key.gpg.enc -out private-key.gpg -d
            - gpg --import private-key.gpg
            - bash ./gradlew publish -Psigning.keyId=$GPG_KEY -Psigning.password=$GPG_PASSWORD

  pull-requests:
    feature/*:
      - step:
          name: Build software
          caches:
            - gradle
          script:
            - bash ./gradlew check #jacocoTestReport -- jacoco does not work with java 15 and gradle yet
          artifacts:
            - ./.gradle/**
            - ./**/build/**
      - step:
          name: Quality Gate
          caches:
            - gradle
          script:
            - bash ./gradlew sonarqube

  branches:
    master:
      - step:
          name: Build software
          caches:
            - gradle
          script:
            - bash ./gradlew check #jacocoTestReport -- jacoco does not work with java 15 and gradle yet
          artifacts:
            - ./.gradle/**
            - ./**/build/**
      - parallel:
          - step:
              name: Deploy snapshot
              caches:
                - gradle
              script:
                - export GPG_TTY=$(tty)
                - yum install openssl11 gnupg -y
                - openssl11 aes-256-cbc -a -k "$SIGNING_PWD" -in private-key.gpg.enc -out private-key.gpg -d
                - gpg --import private-key.gpg
                - printf "signing.keyId=$GPG_KEY\nsigning.password=$GPG_PASSWORD\nsigning.secretKeyRingFile=./private-key.gpg" > ~/.gradle/gradle.properties
                - bash ./gradlew publish
          - step:
              name: Quality gate
              caches:
                - gradle
              script:
                - bash ./gradlew sonarqube
